data/in/mapaction: | data/in ## Dir for extract from planet pbf dump
	mkdir -p $@

data/out/mapaction: | data/out ## Dir for exported files
	mkdir -p $@

data/in/mapaction/ne_10m_rivers_lake_centerlines.zip: | ## download ne_10m_rivers_lake_centerlines
	curl "https://naciscdn.org/naturalearth/10m/physical/ne_10m_rivers_lake_centerlines.zip" -o $@

data/in/mapaction/ne_10m_rivers_lake_centerlines: | data/in/mapaction ## ne_10m_rivers_lake_centerlines
	mkdir -p $@

data/in/mapaction/ne_10m_rivers_lake_centerlines/ne_10m_rivers_lake_centerlines.shp: data/in/mapaction/ne_10m_rivers_lake_centerlines.zip | data/in/mapaction/ne_10m_rivers_lake_centerlines ## unzip ne_10m_rivers_lake_centerlines
	unzip data/in/mapaction/ne_10m_rivers_lake_centerlines -d $@

data/out/ne_10m_rivers_lake_centerlines_per_country_extractions: data/in/mapaction/ne_10m_rivers_lake_centerlines/ne_10m_rivers_lake_centerlines.shp | data/out  ## ne_10m_rivers_lake_centerlines per country extractions
	ls static_data/countries | parallel 'bash scripts/mapaction_extract_country_from_shp.sh {} data/in/mapaction/ne_10m_rivers_lake_centerlines/ne_10m_rivers_lake_centerlines.shp data/out/{country_code}/221_phys/{country_code}_phys_riv_ln_s0_naturalearth_pp_rivers.shp'
	touch $@

data/in/mapaction/ne_10m_coastline.zip: | data/in/mapaction ## ne_10m_coastline
	curl "https://naciscdn.org/naturalearth/10m/physical/ne_10m_coastline.zip" -o $@

data/in/mapaction/ne_10m_coastline: | data/in/mapaction ## ne_10m_coastline
	mkdir -p $@

data/in/mapaction/ne_10m_coastline/ne_10m_coastline.shp: data/in/mapaction/ne_10m_coastline.zip | data/in/mapaction/ne_10m_coastline ## unzip ne_10m_coastline
	unzip data/in/mapaction/ne_10m_coastline -d $@

data/out/ne_10m_coastline_per_country_extractions: data/in/mapaction/ne_10m_coastline/ne_10m_coastline.shp | data/out ## ne_10m_coastline per country extractions
	ls static_data/countries | parallel 'bash scripts/mapaction_extract_country_from_shp.sh {} data/in/mapaction/ne_10m_coastline/ne_10m_coastline.shp data/out/{country_code}/211_elev/{country_code}_elev_cst_ln_s0_naturalearth_pp_coastline.shp'
	touch $@

data/in/mapaction/ne_10m_roads.zip: | data/in/mapaction ## ne_10m_roads
	curl "https://naciscdn.org/naturalearth/10m/cultural/ne_10m_roads.zip" -o $@

data/in/mapaction/ne_10m_roads: | data/in/mapaction ## ne_10m_roads
	mkdir -p $@

data/in/mapaction/ne_10m_roads/ne_10m_roads.shp: data/in/mapaction/ne_10m_roads.zip | data/in/mapaction/ne_10m_roads ## unzip ne_10m_roads
	unzip data/in/mapaction/ne_10m_roads -d $@

data/out/ne_10m_roads_per_country_extractions: data/in/mapaction/ne_10m_roads/ne_10m_roads.shp | data/out ## ne_10m_roads per country extractions
	ls static_data/countries | parallel 'bash scripts/mapaction_extract_country_from_shp.sh {} data/in/mapaction/ne_10m_roads/ne_10m_roads.shp data/out/{country_code}/232_tran/{country_code}_tran_rds_ln_s0_naturalearth_pp_roads.shp'
	touch $@

data/in/mapaction/ne_10m_populated_places.zip: | data/in/mapaction ## ne_10m_populated_placess
	curl "https://naciscdn.org/naturalearth/10m/cultural/ne_10m_populated_places.zip" -o $@

data/in/mapaction/ne_10m_populated_places: | data/in/mapaction ## ne_10m_populated_placess
	mkdir -p $@

data/in/mapaction/ne_10m_populated_places/ne_10m_populated_places.shp: data/in/mapaction/ne_10m_populated_places.zip | data/in/mapaction/ne_10m_populated_places ## unzip ne_10m_populated_placess
	unzip data/in/mapaction/ne_10m_populated_places -d $@

data/out/ne_10m_populated_places_per_country_extractions: data/in/mapaction/ne_10m_populated_places/ne_10m_populated_places.shp | data/out ## ne_10m_populated_placess per country extractions
	ls static_data/countries | parallel 'bash scripts/mapaction_extract_country_from_shp.sh {} data/in/mapaction/ne_10m_populated_places/ne_10m_populated_places.shp data/out/{country_code}/229_stle/{country_code}_stle_stl_pt_s0_naturalearth_pp_maincities.shp'
	touch $@

data/in/mapaction/ne_10m_lakes.zip: | data/in/mapaction ## ne_10m_lakes
	curl "https://naciscdn.org/naturalearth/10m/physical/ne_10m_lakes.zip" -o $@

data/in/mapaction/ne_10m_lakes: | data/in/mapaction ## ne_10m_lakes
	mkdir -p $@

data/in/mapaction/ne_10m_lakes/ne_10m_lakes.shp: data/in/mapaction/ne_10m_lakes.zip | data/in/mapaction/ne_10m_lakes ## unzip ne_10m_lakes
	unzip data/in/mapaction/ne_10m_lakes -d $@

data/out/ne_10m_lakes_per_country_extractions: data/in/mapaction/ne_10m_lakes/ne_10m_lakes.shp | data/out ## ne_10m_lakes per country extractions
	ls static_data/countries | parallel 'bash scripts/mapaction_extract_country_from_shp.sh {} data/in/mapaction/ne_10m_lakes/ne_10m_lakes.shp data/out/{country_code}/221_phys/{country_code}_phys_lak_py_s0_naturalearth_pp_waterbodies.shp'
	touch $@

data/in/mapaction/per_country_pbf: data/planet-latest-updated.osm.pbf | data/in/mapaction ## create per-country extracts pbf files from planet.pbf
	ls static_data/countries/*.json | parallel 'bash scripts/osm_pbf_extract.sh {}'
	touch $@

db/table/osm_data_import: data/in/mapaction/per_country_pbf | db/table ## Create and populate "osm_[]" tables in db
	ls data/in/mapaction/*.pbf | parallel 'bash scripts/osm_data_import.sh {}'
	touch $@

db/table/mapaction_data_table: db/table/osm_data_import | db/table ## Create and populate "mapaction_[]" tables in db
	ls data/in/mapaction/*.pbf | parallel 'bash scripts/mapaction_data_table.sh {}'
	touch $@

data/out/mapaction/mapaction_export: db/table/mapaction_data_table | data/out/mapaction ## Export from db to SHP and JSON
	psql -f scripts/mapaction_data_export.sql
	ls data/in/mapaction/*.pbf | parallel 'bash scripts/mapaction_export.sh {}'
	touch $@

dev: data/in/mapaction ## this runs when autos_tart.sh executes
	echo "dev target successfully build"
	touch $@
