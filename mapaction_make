data/in/mapaction: | data/in ## Dir for extract from planet pbf dump
	mkdir -p $@

data/out/mapaction: | data/out ## Dir for exported files
	mkdir -p $@

data/in/mapaction/per_country_pbf: data/planet-latest-updated.osm.pbf | data/in/mapaction ## create per-country extracts pbf files from planet.pbf
	ls static_data/mapaction/countries/*.json | parallel 'bash scripts/osm_data_extract.sh {}'
	touch $@

db/table/osm_data_import: data/in/mapaction/per_country_pbf | db/table ## Create and populate "osm_[]" tables in db
	ls data/in/mapaction/*.pbf | parallel 'bash scripts/osm_data_import.sh {}'
	touch $@

db/table/mapaction_data_table: db/table/osm_data_import | db/table ## Create and populate "mapaction_[]" tables in db
	ls data/in/mapaction/*.pbf | parallel 'bash scripts/mapaction_data_table.sh {}'
	touch $@

data/out/mapaction/mapaction_export: db/table/mapaction_data_table | data/out/mapaction ## Export from db to SHP and JSON
	psql -f scripts/mapaction_data_export.sql
	ls data/in/mapaction/*.pbf | parallel 'bash scripts/mapaction_export.sh {}'
	touch $@

dev: db/table/mapaction_data_table ## dev target
